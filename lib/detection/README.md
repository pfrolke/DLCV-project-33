Cloned and adapted from https://github.com/tensorflow/tpu